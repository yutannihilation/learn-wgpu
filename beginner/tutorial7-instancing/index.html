<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Instancing | Learn Wgpu</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="">
    <meta property="article:modified_time" content="2020-05-11T16:24:44.000Z">
    <meta property="og:site_name" content="Learn Wgpu">
    <meta property="og:title" content="Instancing">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/beginner/tutorial7-instancing/">
    <meta name="twitter:title" content="Instancing">
    <meta name="twitter:url" content="/beginner/tutorial7-instancing/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data2" content="Benjamin R Hansen">
    <meta name="twitter:creator" content="https://twitter.com/sotrh760">
    <link rel="preload" href="/learn-wgpu/assets/css/0.styles.37e58535.css" as="style"><link rel="preload" href="/learn-wgpu/assets/js/app.f81b0d6c.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/2.0cd910cf.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/11.638df742.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/19.9711265a.js" as="script"><link rel="prefetch" href="/learn-wgpu/assets/js/10.9e2a47f6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/12.6c2c8778.js"><link rel="prefetch" href="/learn-wgpu/assets/js/13.7dc1ded5.js"><link rel="prefetch" href="/learn-wgpu/assets/js/14.510faa9f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/15.c21d69e1.js"><link rel="prefetch" href="/learn-wgpu/assets/js/16.67a463f3.js"><link rel="prefetch" href="/learn-wgpu/assets/js/17.c6d24d48.js"><link rel="prefetch" href="/learn-wgpu/assets/js/18.43a69954.js"><link rel="prefetch" href="/learn-wgpu/assets/js/20.62f9e814.js"><link rel="prefetch" href="/learn-wgpu/assets/js/21.d6f10868.js"><link rel="prefetch" href="/learn-wgpu/assets/js/22.73b0831f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/23.2c0eb363.js"><link rel="prefetch" href="/learn-wgpu/assets/js/24.a2e97358.js"><link rel="prefetch" href="/learn-wgpu/assets/js/25.8c4b3520.js"><link rel="prefetch" href="/learn-wgpu/assets/js/3.e0ae4f10.js"><link rel="prefetch" href="/learn-wgpu/assets/js/4.e7bd6c5d.js"><link rel="prefetch" href="/learn-wgpu/assets/js/5.e163b378.js"><link rel="prefetch" href="/learn-wgpu/assets/js/6.0d8ed5e8.js"><link rel="prefetch" href="/learn-wgpu/assets/js/7.20645a46.js"><link rel="prefetch" href="/learn-wgpu/assets/js/8.a40e7f6a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/9.87b3cb21.js">
    <link rel="stylesheet" href="/learn-wgpu/assets/css/0.styles.37e58535.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu/" class="home-link router-link-active"><!----> <span class="site-name">Learn Wgpu</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu/" class="sidebar-link">Introduction</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Beginner</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/beginner/tutorial1-window/" class="sidebar-link">Dependencies and the window</a></li><li><a href="/learn-wgpu/beginner/tutorial2-swapchain/" class="sidebar-link">The Swapchain</a></li><li><a href="/learn-wgpu/beginner/tutorial3-pipeline/" class="sidebar-link">The Pipeline</a></li><li><a href="/learn-wgpu/beginner/tutorial4-buffer/" class="sidebar-link">Buffers and Indices</a></li><li><a href="/learn-wgpu/beginner/tutorial5-textures/" class="sidebar-link">Textures and bind groups</a></li><li><a href="/learn-wgpu/beginner/tutorial6-uniforms/" class="sidebar-link">Uniform buffers and a 3d camera</a></li><li><a href="/learn-wgpu/beginner/tutorial7-instancing/" class="active sidebar-link">Instancing</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial7-instancing/#the-naive-method" class="sidebar-link">The naive method</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial7-instancing/#a-better-way-uniform-arrays" class="sidebar-link">A better way - uniform arrays</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial7-instancing/#another-better-way-storage-buffers" class="sidebar-link">Another better way - storage buffers</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial7-instancing/#another-better-way-vertex-buffers" class="sidebar-link">Another better way - vertex buffers</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial7-instancing/#a-different-way-textures" class="sidebar-link">A different way - textures</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial7-instancing/#recap" class="sidebar-link">Recap</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial7-instancing/#about-the-depth-issues" class="sidebar-link">About the depth issues...</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial7-instancing/#challenge" class="sidebar-link">Challenge</a></li></ul></li><li><a href="/learn-wgpu/beginner/tutorial8-depth/" class="sidebar-link">The Depth Buffer</a></li><li><a href="/learn-wgpu/beginner/tutorial9-models/" class="sidebar-link">Model Loading</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Intermediate</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/intermediate/tutorial10-lighting/" class="sidebar-link">Working with Lights</a></li><li><a href="/learn-wgpu/intermediate/tutorial11-normals/" class="sidebar-link">Normal Mapping</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Showcase</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/learn-wgpu/news/" class="sidebar-link">News</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="instancing"><a href="#instancing" class="header-anchor">#</a> Instancing</h1> <p>Up to this point we've been drawing just one object. Most games have hundreds of objects on screen at the same time. If we wanted to draw multiple instances of our model, we could copy the vertex buffer and modify it's vertices to be in the right place, but this would be hilariously inefficient. We have our model, and we now how to position it in 3d space with a matrix, like we did the camera, so all we have to do is change the matrix we're using when we draw.</p> <h2 id="the-naive-method"><a href="#the-naive-method" class="header-anchor">#</a> The naive method</h2> <p>First let's modify <code>Uniforms</code> to include a <code>model</code> property.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[derive(Debug, Copy, Clone)]</span>
<span class="token keyword">struct</span> Uniforms <span class="token punctuation">{</span>
    view_proj<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    model<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
<span class="token punctuation">}</span>

<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> bytemuck<span class="token punctuation">::</span>Pod <span class="token keyword">for</span> Uniforms <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> bytemuck<span class="token punctuation">::</span>Zeroable <span class="token keyword">for</span> Uniforms <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span> Uniforms <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> cgmath<span class="token punctuation">::</span>SquareMatrix<span class="token punctuation">;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            view_proj<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token punctuation">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            model<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token punctuation">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function">update_view_proj</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> camera<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Camera<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>view_proj <span class="token operator">=</span> OPENGL_TO_WGPU_MATRIX <span class="token operator">*</span> camera<span class="token punctuation">.</span><span class="token function">build_view_projection_matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>With that let's introduce another struct for our instances. We'll use it to store the position and rotation of our instances. We'll also have a method to convert our instance data into a matrix that we can give to <code>Uniforms</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> Instance <span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Vector3<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    rotation<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Quaternion<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Instance <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">to_matrix</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        cgmath<span class="token punctuation">::</span>Matrix4<span class="token punctuation">::</span><span class="token function">from_translation</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>position<span class="token punctuation">)</span>
            <span class="token operator">*</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>rotation<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Next we'll add <code>instances: Vec&lt;Instance&gt;,</code> to <code>State</code> and create our instances with the following in <code>new()</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// ...</span>

<span class="token comment">// add these at the top of the file</span>
<span class="token keyword">const</span> NUM_INSTANCES_PER_ROW<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> NUM_INSTANCES<span class="token punctuation">:</span> u32 <span class="token operator">=</span> NUM_INSTANCES_PER_ROW <span class="token operator">*</span> NUM_INSTANCES_PER_ROW<span class="token punctuation">;</span>
<span class="token keyword">const</span> INSTANCE_DISPLACEMENT<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Vector3<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span> <span class="token operator">=</span> cgmath<span class="token punctuation">::</span>Vector3<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>NUM_INSTANCES_PER_ROW <span class="token keyword">as</span> f32 <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> NUM_INSTANCES_PER_ROW <span class="token keyword">as</span> f32 <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// make a 10 by 10 grid of objects</span>
<span class="token keyword">let</span> instances <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span>NUM_INSTANCES_PER_ROW<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flat_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>z<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span>NUM_INSTANCES_PER_ROW<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token punctuation">|</span>x<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> position <span class="token operator">=</span> cgmath<span class="token punctuation">::</span>Vector3 <span class="token punctuation">{</span> x<span class="token punctuation">:</span> x <span class="token keyword">as</span> f32<span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> z <span class="token keyword">as</span> f32 <span class="token punctuation">}</span> <span class="token operator">-</span> INSTANCE_DISPLACEMENT<span class="token punctuation">;</span>

        <span class="token keyword">let</span> rotation <span class="token operator">=</span> <span class="token keyword">if</span> position<span class="token punctuation">.</span><span class="token function">is_zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// this is needed so an object at (0, 0, 0) won't get scaled to zero</span>
            <span class="token comment">// as Quaternions can effect scale if they're not create correctly</span>
            cgmath<span class="token punctuation">::</span>Quaternion<span class="token punctuation">::</span><span class="token function">from_axis_angle</span><span class="token punctuation">(</span>cgmath<span class="token punctuation">::</span>Vector3<span class="token punctuation">::</span><span class="token function">unit_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cgmath<span class="token punctuation">::</span><span class="token function">Deg</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            cgmath<span class="token punctuation">::</span>Quaternion<span class="token punctuation">::</span><span class="token function">from_axis_angle</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cgmath<span class="token punctuation">::</span><span class="token function">Deg</span><span class="token punctuation">(</span><span class="token number">45.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        Instance <span class="token punctuation">{</span>
            position<span class="token punctuation">,</span> rotation<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>

<span class="token keyword">Self</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    instances<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now that that's done, we need to update <code>shader.vert</code> to use the model matrix passed in through <code>Uniforms</code>.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token preprocessor builtin">#version</span> <span class="token number">450</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> a_position<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> a_tex_coords<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec2</span> v_tex_coords<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>set<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> binding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">uniform</span> Uniforms <span class="token punctuation">{</span>
    <span class="token keyword">mat4</span> u_view_proj<span class="token punctuation">;</span>
    <span class="token keyword">mat4</span> u_model<span class="token punctuation">;</span> <span class="token comment">// NEW!</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v_tex_coords <span class="token operator">=</span> a_tex_coords<span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> u_view_proj <span class="token operator">*</span> u_model <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// UPDATED!</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If you run the program now, you won't see anything different. That's because we aren't actually updating the uniform buffer at all. Using our current method, we need to update the uniform buffer for every instance we draw. We'll do this in <code>render()</code> with something like the following.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">for</span> instance <span class="token keyword">in</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>instances <span class="token punctuation">{</span>
    <span class="token comment">// 1.</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>uniforms<span class="token punctuation">.</span>model <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">to_matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> staging_buffer <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>device<span class="token punctuation">.</span><span class="token function">create_buffer_with_data</span><span class="token punctuation">(</span>
        bytemuck<span class="token punctuation">::</span><span class="token function">cast_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>uniforms<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        wgpu<span class="token punctuation">::</span>BufferUsage<span class="token punctuation">::</span>COPY_SRC<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    encoder<span class="token punctuation">.</span><span class="token function">copy_buffer_to_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>staging_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>uniform_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span>size_of<span class="token punctuation">::</span><span class="token operator">&lt;</span>Uniforms<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> wgpu<span class="token punctuation">::</span>BufferAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2.</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> render_pass <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">begin_render_pass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>RenderPassDescriptor <span class="token punctuation">{</span>
        color_attachments<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
            wgpu<span class="token punctuation">::</span>RenderPassColorAttachmentDescriptor <span class="token punctuation">{</span>
                attachment<span class="token punctuation">:</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">.</span>view<span class="token punctuation">,</span>
                resolve_target<span class="token punctuation">:</span> None<span class="token punctuation">,</span>
                load_op<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>LoadOp<span class="token punctuation">::</span>Load<span class="token punctuation">,</span> <span class="token comment">// 3.</span>
                store_op<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>StoreOp<span class="token punctuation">::</span>Store<span class="token punctuation">,</span>
                clear_color<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>Color <span class="token punctuation">{</span>
                    r<span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
                    g<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
                    b<span class="token punctuation">:</span> <span class="token number">0.3</span><span class="token punctuation">,</span>
                    a<span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        depth_stencil_attachment<span class="token punctuation">:</span> None<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    render_pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>render_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
    render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>diffuse_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>uniform_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vertex_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    render_pass<span class="token punctuation">.</span><span class="token function">set_index_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>index_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    render_pass<span class="token punctuation">.</span><span class="token function">draw_indexed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>num_indices<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Some things to note:</p> <ol><li>We're creating a hundred buffers a frame. This is inefficent, but we'll cover better ways of doing this later in this tutorial.</li> <li>We have to create a new render pass per instance, as we can't modify the uniform buffer while we have one active.</li> <li>We use <code>LoadOp::Load</code> here to prevent the render pass from clearing the entire screen after each draw. This means we lose our clear color. This makes the background black on my machine, but it may be filled with garbage data on yours. We can fix this by added another render pass before the loop.</li></ol> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token punctuation">{</span>
    encoder<span class="token punctuation">.</span><span class="token function">begin_render_pass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>RenderPassDescriptor <span class="token punctuation">{</span>
        color_attachments<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
            wgpu<span class="token punctuation">::</span>RenderPassColorAttachmentDescriptor <span class="token punctuation">{</span>
                attachment<span class="token punctuation">:</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">.</span>view<span class="token punctuation">,</span>
                resolve_target<span class="token punctuation">:</span> None<span class="token punctuation">,</span>
                load_op<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>LoadOp<span class="token punctuation">::</span>Clear<span class="token punctuation">,</span>
                store_op<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>StoreOp<span class="token punctuation">::</span>Store<span class="token punctuation">,</span>
                clear_color<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>Color <span class="token punctuation">{</span>
                    r<span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
                    g<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
                    b<span class="token punctuation">:</span> <span class="token number">0.3</span><span class="token punctuation">,</span>
                    a<span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        depth_stencil_attachment<span class="token punctuation">:</span> None<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We should get something that looks like this when we're done.</p> <p><img src="/learn-wgpu/assets/img/forest.5c5cf3ad.png" alt="A beautiful forest"></p> <p>If you haven't guessed already, this way of instancing is not the best. It requires hundreds of render passes, hundereds of staging buffers, and an extra render pass just to get the clear color working again. Cleary there must be a better way.</p> <h2 id="a-better-way-uniform-arrays"><a href="#a-better-way-uniform-arrays" class="header-anchor">#</a> A better way - uniform arrays</h2> <p>Since GLSL is based on C, it supports arrays. We can leverage this by store <em>all</em> of the instance matrices in the <code>Uniforms</code> struct. We need to make this change on the Rust side, as well as in our shader.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[derive(Copy, Clone)]</span>
<span class="token keyword">struct</span> Uniforms <span class="token punctuation">{</span>
    view_proj<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    model<span class="token punctuation">:</span> <span class="token punctuation">[</span>cgmath<span class="token punctuation">::</span>Matrix4<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">;</span> NUM_INSTANCES <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token preprocessor builtin">#version</span> <span class="token number">450</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> a_position<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> a_tex_coords<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec2</span> v_tex_coords<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>set<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> binding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">uniform</span> Uniforms <span class="token punctuation">{</span>
    <span class="token keyword">mat4</span> u_view_proj<span class="token punctuation">;</span>
    <span class="token keyword">mat4</span> u_model<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v_tex_coords <span class="token operator">=</span> a_tex_coords<span class="token punctuation">;</span>
    <span class="token comment">// gl_InstanceIndex what index we're currently on</span>
    gl_Position <span class="token operator">=</span> u_view_proj <span class="token operator">*</span> u_model<span class="token punctuation">[</span>gl_InstanceIndex<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Note that we're using an array, <em>not a <code>Vec</code></em>. <code>Vec</code>s are basically pointers to an array on the heap. Our graphics card doesn't know how follow a pointer to the heap, so our data needs to be stored inline.</p> <p><code>Uniforms::new()</code> will change slightly as well.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
    <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        view_proj<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token punctuation">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        model<span class="token punctuation">:</span> <span class="token punctuation">[</span>cgmath<span class="token punctuation">::</span>Matrix4<span class="token punctuation">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> NUM_INSTANCES <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We need to update our model matrices in <code>State::update()</code> before we create the <code>staging_buffer</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> instance<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">self</span><span class="token punctuation">.</span>instances<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>uniforms<span class="token punctuation">.</span>model<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">to_matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Lastly we need to change our render code. Fortunately, it's a lot simpler than the before. In fact we can use the code from last tutorial and just change our draw call.</p> <div class="language-rust extra-class"><pre class="language-rust"><code>render_pass<span class="token punctuation">.</span><span class="token function">draw_indexed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>num_indices<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span>NUM_INSTANCES<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>You'll remember that the 3rd parameter in <code>draw_indexed</code> is the instance range. This controls how many times our object will be drawn. This is where our shader gets the value for <code>gl_InstanceIndex</code>.</p> <p>Running the program now won't change anything visually from our last example, but the framerate will be better.</p> <p>This technique has its drawbacks.</p> <ol><li>We can't use a <code>Vec</code> like we've mentioned before</li> <li>We're limited in the number of instances we can process at a time requiring use to cap it at some abitrary number, or render things in &quot;batches&quot;. If we want to increase the size of instances, we have to recompile our code.</li></ol> <h2 id="another-better-way-storage-buffers"><a href="#another-better-way-storage-buffers" class="header-anchor">#</a> Another better way - storage buffers</h2> <p>A storage buffer gives us the flexibility that arrays did not. We don't have to specify it's size in the shader, and we can even use a <code>Vec</code> to create it!</p> <p>Since we're using <code>bytemuck</code> for casting our data to <code>&amp;[u8]</code>, we're going to need to define a custom scruct to store the <code>cgmath::Matrix4</code>s. We need to do this because we can't implement <code>bytemuck::Pod</code>, and <code>bytemuck::Zeroable</code>, on <code>cgmath::Matrix4</code> because we don't that type.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// UPDATED!</span>
<span class="token keyword">impl</span> Instance <span class="token punctuation">{</span>
    <span class="token comment">// This is changed from `to_matrix()`</span>
    <span class="token keyword">fn</span> <span class="token function">to_raw</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> InstanceRaw <span class="token punctuation">{</span>
        InstanceRaw <span class="token punctuation">{</span>
            model<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token punctuation">::</span><span class="token function">from_translation</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>position<span class="token punctuation">)</span> <span class="token operator">*</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>rotation<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// NEW!</span>
<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[derive(Copy, Clone)]</span>
<span class="token keyword">struct</span> InstanceRaw <span class="token punctuation">{</span>
    model<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> bytemuck<span class="token punctuation">::</span>Pod <span class="token keyword">for</span> InstanceRaw <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> bytemuck<span class="token punctuation">::</span>Zeroable <span class="token keyword">for</span> InstanceRaw <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>We create a storage buffer in a similar way as any other buffer.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> instance_data <span class="token operator">=</span> instances<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Instance<span class="token punctuation">::</span>to_raw<span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">::</span><span class="token operator">&lt;</span>Vec<span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// we'll need the size for later</span>
<span class="token keyword">let</span> instance_buffer_size <span class="token operator">=</span> instance_data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span>size_of<span class="token punctuation">::</span><span class="token operator">&lt;</span>cgmath<span class="token punctuation">::</span>Matrix4<span class="token operator">&lt;</span>f32<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> instance_buffer <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_buffer_with_data</span><span class="token punctuation">(</span>
    bytemuck<span class="token punctuation">::</span><span class="token function">cast_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>instance_data<span class="token punctuation">)</span><span class="token punctuation">,</span>
    wgpu<span class="token punctuation">::</span>BufferUsage<span class="token punctuation">::</span>STORAGE_READ<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>To get this buffer into the shader, we'll need to attach it to a bind group. We'll use <code>uniform_bind_group</code> just to keep things simple.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> uniform_bind_group_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>BindGroupLayoutDescriptor <span class="token punctuation">{</span>
    bindings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        <span class="token comment">// ...</span>
        wgpu<span class="token punctuation">::</span>BindGroupLayoutEntry <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            visibility<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>ShaderStage<span class="token punctuation">::</span>VERTEX<span class="token punctuation">,</span>
            ty<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingType<span class="token punctuation">::</span>StorageBuffer <span class="token punctuation">{</span>
                dynamic<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
                readonly<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> uniform_bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>BindGroupDescriptor <span class="token punctuation">{</span>
    layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span>uniform_bind_group_layout<span class="token punctuation">,</span>
    bindings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        <span class="token comment">// ...</span>
        wgpu<span class="token punctuation">::</span>Binding <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            resource<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingResource<span class="token punctuation">::</span>Buffer <span class="token punctuation">{</span>
                buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span>instance_buffer<span class="token punctuation">,</span>
                range<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">..</span>instance_buffer_size <span class="token keyword">as</span> wgpu<span class="token punctuation">::</span>BufferAddress<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><em>Note you'll probably need to shift your <code>instance_buffer</code> creation above the <code>uniform_bind_group</code> creation.</em></p> <p>We'll want to put <code>instance_buffer</code> into the <code>State</code> struct.</p> <p>You don't need to change the draw call at all from the previous example, but we'll need to change the vertex shader.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token preprocessor builtin">#version</span> <span class="token number">450</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> a_position<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> a_tex_coords<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec2</span> v_tex_coords<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>set<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> binding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">uniform</span> Uniforms <span class="token punctuation">{</span>
    <span class="token keyword">mat4</span> u_view_proj<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>set<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> binding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">buffer</span> Instances <span class="token punctuation">{</span>
    <span class="token keyword">mat4</span> s_models<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v_tex_coords <span class="token operator">=</span> a_tex_coords<span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> u_view_proj <span class="token operator">*</span> s_models<span class="token punctuation">[</span>gl_InstanceIndex<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You can see that we got rid of the <code>u_model</code> field from the <code>Uniforms</code> block and create a new <code>Instances</code> located at <code>set=1, binding=1</code> corresponding with our bind group layout. Another thing to notice is that we use the <code>buffer</code> keyword for the block instead of <code>uniform</code>. The details of the <code>buffer</code> can be found on <a href="https://www.khronos.org/opengl/wiki/Shader_Storage_Buffer_Object" target="_blank" rel="noopener noreferrer">the OpenGL wiki<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>This method is nice because it allows us to store more data overall as storage buffers can theoretically store as much data as the GPU can handle, where uniform buffers are capped. This does mean that storage buffers are slower that uniform buffers as they are stored like other buffers such as textures as and therefore aren't as close in memory, but that usually won't matter much if you're dealing with large amounts of data.</p> <p>Another benefit to storage buffers is that they can be written to by the shader, unlike uniform buffers. If we want to mutate a large amount of data with a compute shader, we'd use a writeable storage buffer for our output (and potentially input as well).</p> <h2 id="another-better-way-vertex-buffers"><a href="#another-better-way-vertex-buffers" class="header-anchor">#</a> Another better way - vertex buffers</h2> <p>When we created the <code>VertexBufferDescriptor</code> for our model, it required a <code>step_mode</code> field. We used <code>InputStepMode::Vertex</code>, this time we'll create a <code>VertexBufferDescriptor</code> for our <code>instance_buffer</code>.</p> <p>We'll take the code from the previous example and then create a trait called <code>VBDesc</code>, and implement it for <code>Vertex</code> (replacing the old <code>impl</code>), and a newly created <code>InstanceRaw</code> class. <em>Note: we could just <code>impl VBDesc for cgmath::Matrix4&lt;f32&gt;</code> instead, but instances could have more data in the future, so it's better to create a new struct.</em></p> <p>Here's our new trait.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">trait</span> VBDesc <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> desc<span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> wgpu<span class="token punctuation">::</span>VertexBufferDescriptor<span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>To change <code>Vertex</code> to use this, we just have to swap <code>impl Vertex</code>, for <code>impl VBDesc for Vertex</code>.</p> <p>With that done we can implement <code>VBDesc</code> for <code>InstanceRaw</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">const</span> FLOAT_SIZE<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BufferAddress <span class="token operator">=</span> std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span>size_of<span class="token punctuation">::</span><span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> wgpu<span class="token punctuation">::</span>BufferAddress<span class="token punctuation">;</span>
<span class="token keyword">impl</span> VBDesc <span class="token keyword">for</span> InstanceRaw <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> desc<span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> wgpu<span class="token punctuation">::</span>VertexBufferDescriptor<span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        wgpu<span class="token punctuation">::</span>VertexBufferDescriptor <span class="token punctuation">{</span>
            stride<span class="token punctuation">:</span> std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span>size_of<span class="token punctuation">::</span><span class="token operator">&lt;</span>InstanceRaw<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> wgpu<span class="token punctuation">::</span>BufferAddress<span class="token punctuation">,</span>
            step_mode<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>InputStepMode<span class="token punctuation">::</span>Instance<span class="token punctuation">,</span> <span class="token comment">// 1.</span>
            attributes<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                wgpu<span class="token punctuation">::</span>VertexAttributeDescriptor <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>VertexFormat<span class="token punctuation">::</span>Float4<span class="token punctuation">,</span> <span class="token comment">// 2.</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 3.</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                wgpu<span class="token punctuation">::</span>VertexAttributeDescriptor <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> FLOAT_SIZE <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>VertexFormat<span class="token punctuation">::</span>Float4<span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                wgpu<span class="token punctuation">::</span>VertexAttributeDescriptor <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> FLOAT_SIZE <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>VertexFormat<span class="token punctuation">::</span>Float4<span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                wgpu<span class="token punctuation">::</span>VertexAttributeDescriptor <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> FLOAT_SIZE <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>VertexFormat<span class="token punctuation">::</span>Float4<span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Let's unpack this a bit.</p> <ol><li>This line makes what would be a vertex buffer into and index buffer. If we didn't specify this, the shader would loop through the elements in this list for every vertex.</li> <li>Vertex attributes have a limited size: <code>Float4</code> or the equivalent. This means that our instance buffer will take up multiple attribute slots. 4 in our case.</li> <li>Since we're using 2 slots for our <code>Vertex</code> struct, we need to start the <code>shader_location</code> at 2.</li></ol> <p>Now we need to add a <code>VertexBufferDescriptor</code> to our <code>render_pipeline</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> render_pipeline <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_render_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>RenderPipelineDescriptor <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    vertex_state<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>VertexStateDescriptor <span class="token punctuation">{</span>
        index_format<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>IndexFormat<span class="token punctuation">::</span>Uint16<span class="token punctuation">,</span>
        vertex_buffers<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
            Vertex<span class="token punctuation">::</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            InstanceRaw<span class="token punctuation">::</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><em>You'll probably want to remove the <code>BindGroupLayoutBinding</code> and <code>Binding</code> from <code>uniform_bind_group_layout</code> and <code>uniform_bind_group</code> respectively, as we won't be accessing our buffer from there.</em></p> <p>We'll also want to change <code>instance_buffer</code>'s <code>BufferUsage</code> to <code>VERTEX</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> instance_data <span class="token operator">=</span> instances<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Instance<span class="token punctuation">::</span>to_raw<span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">::</span><span class="token operator">&lt;</span>Vec<span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> instance_buffer <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_buffer_with_data</span><span class="token punctuation">(</span>
    bytemuck<span class="token punctuation">::</span><span class="token function">cast_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>instance_data<span class="token punctuation">)</span><span class="token punctuation">,</span>
    wgpu<span class="token punctuation">::</span>BufferUsage<span class="token punctuation">::</span>VERTEX<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This last thing we'll need to do from Rust is use our <code>instance_buffer</code> in the <code>render()</code> method.</p> <div class="language-rust extra-class"><pre class="language-rust"><code>render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vertex_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>instance_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// NEW!</span>
</code></pre></div><p>Now we get to the shader. We don't have to change much, we just make our shader reference our <code>instance_buffer</code> through the attributes rather than a uniform/buffer block.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token preprocessor builtin">#version</span> <span class="token number">450</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> a_position<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> a_tex_coords<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">mat4</span> a_model<span class="token punctuation">;</span> <span class="token comment">// NEW!</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec2</span> v_tex_coords<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>set<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> binding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">uniform</span> Uniforms <span class="token punctuation">{</span>
    <span class="token keyword">mat4</span> u_view_proj<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v_tex_coords <span class="token operator">=</span> a_tex_coords<span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> u_view_proj <span class="token operator">*</span> a_model <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// UPDATED!</span>
<span class="token punctuation">}</span>
</code></pre></div><p>That's all you need to get an instance buffer working! There's a bit of overhead to get things working, and there are a few quirks, but it gets the job.</p> <h2 id="a-different-way-textures"><a href="#a-different-way-textures" class="header-anchor">#</a> A different way - textures</h2> <p>This seems like a really backwards way to do instancing. Storing non image data in a texture seems really bizarre even though it's a perfectly valid thing to do. After all, a texture is just an array of bytes, and that could theoretically be anything. In our case, we're going to cram our matrix data into that array of bytes.</p> <p>If you're following along, it'd be best to start from the storage buffer example. We're going to modify it to take our <code>instance_buffer</code>, and copy it into a 1D <code>instance_texture</code>. First we need to create the texture.</p> <ul><li>We won't use our <code>texture</code> module for this, though we could refactor it to store random data as a texture.</li></ul> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> instance_extent <span class="token operator">=</span> wgpu<span class="token punctuation">::</span>Extent3d <span class="token punctuation">{</span>
    width<span class="token punctuation">:</span> instance_data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u32 <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    depth<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> instance_texture <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_texture</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>TextureDescriptor <span class="token punctuation">{</span>
    size<span class="token punctuation">:</span> instance_extent<span class="token punctuation">,</span>
    array_layer_count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    mip_level_count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    sample_count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    dimension<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>TextureDimension<span class="token punctuation">::</span>D1<span class="token punctuation">,</span>
    format<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>TextureFormat<span class="token punctuation">::</span>Rgba32Float<span class="token punctuation">,</span>
    usage<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>TextureUsage<span class="token punctuation">::</span>SAMPLED <span class="token operator">|</span> wgpu<span class="token punctuation">::</span>TextureUsage<span class="token punctuation">::</span>COPY_DST<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>All of this is fairly normal texture creation stuff, save two things:</p> <ol><li>We specify the height of the texture as 1. While you could theoretically use a height greater than 1, keeping the texture 1D simplifies things a bit. This also means that we need to use <code>TextureDimension::D1</code> for our <code>dimension</code>.</li> <li>We're using <code>TextureFormat::Rgba32Float</code> for the texture format. Since our matrices are 32bit floats, this makes sense. We could use lower memory formats such as <code>Rgba16Float</code>, or even <code>Rgba8UnormSrgb</code>, but we loose precision when we do that. We might not need that precision for basic rendering, but applications that need to model reality definetly do.</li></ol> <p>With that said, let's create our a texture view and sampler for our <code>instance_texture</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> instance_texture_view <span class="token operator">=</span> instance_texture<span class="token punctuation">.</span><span class="token function">create_default_view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> instance_sampler <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>SamplerDescriptor <span class="token punctuation">{</span>
    address_mode_u<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>AddressMode<span class="token punctuation">::</span>ClampToEdge<span class="token punctuation">,</span>
    address_mode_v<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>AddressMode<span class="token punctuation">::</span>ClampToEdge<span class="token punctuation">,</span>
    address_mode_w<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>AddressMode<span class="token punctuation">::</span>ClampToEdge<span class="token punctuation">,</span>
    mag_filter<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>FilterMode<span class="token punctuation">::</span>Nearest<span class="token punctuation">,</span>
    min_filter<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>FilterMode<span class="token punctuation">::</span>Nearest<span class="token punctuation">,</span>
    minmap_filter<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>FilterMode<span class="token punctuation">::</span>Nearest<span class="token punctuation">,</span>
    lod_min_clamp<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">100.0</span><span class="token punctuation">,</span>
    lod_max_clamp<span class="token punctuation">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
            compare<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>CompareFunction<span class="token punctuation">::</span>Always<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Then we need to copy the <code>instance_buffer</code> to our <code>instance_texture</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> <span class="token keyword">mut</span> encoder <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_command_encoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>CommandEncoderDescriptor <span class="token punctuation">{</span>
    label<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token string">&quot;instance_texture_encoder&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
encoder<span class="token punctuation">.</span><span class="token function">copy_buffer_to_texture</span><span class="token punctuation">(</span>
    wgpu<span class="token punctuation">::</span>BufferCopyView <span class="token punctuation">{</span>
        buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span>instance_buffer<span class="token punctuation">,</span>
        offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        bytes_per_row<span class="token punctuation">:</span> std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span>size_of<span class="token punctuation">::</span><span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u32 <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span>
        rows_per_image<span class="token punctuation">:</span> instance_data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u32 <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    wgpu<span class="token punctuation">::</span>TextureCopyView <span class="token punctuation">{</span>
        texture<span class="token punctuation">:</span> <span class="token operator">&amp;</span>instance_texture<span class="token punctuation">,</span>
        mip_level<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        array_layer<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        origin<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>Origin3d<span class="token punctuation">::</span>ZERO<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    instance_extent<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>encoder<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now we need to add our texture and sampler to a bind group. Let with the storage buffer example, we'll use <code>uniform_bind_group</code> and its corresponding layout.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> uniform_bind_group_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>BindGroupLayoutDescriptor <span class="token punctuation">{</span>
    bindings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        <span class="token comment">// ...</span>
        wgpu<span class="token punctuation">::</span>BindGroupLayoutEntry <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            visibility<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>ShaderStage<span class="token punctuation">::</span>VERTEX<span class="token punctuation">,</span>
            ty<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingType<span class="token punctuation">::</span>SampledTexture <span class="token punctuation">{</span>
                multisampled<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
                component_type<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>TextureComponentType<span class="token punctuation">::</span>Uint<span class="token punctuation">,</span>
                dimension<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>TextureViewDimension<span class="token punctuation">::</span>D1<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        wgpu<span class="token punctuation">::</span>BindGroupLayoutEntry <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            visibility<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>ShaderStage<span class="token punctuation">::</span>VERTEX<span class="token punctuation">,</span>
            ty<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingType<span class="token punctuation">::</span>Sampler<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> uniform_bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>BindGroupDescriptor <span class="token punctuation">{</span>
    layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span>uniform_bind_group_layout<span class="token punctuation">,</span>
    bindings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        <span class="token comment">// ...</span>
        wgpu<span class="token punctuation">::</span>Binding <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            resource<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingResource<span class="token punctuation">::</span><span class="token function">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>instance_texture_view<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        wgpu<span class="token punctuation">::</span>Binding <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            resource<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingResource<span class="token punctuation">::</span><span class="token function">Sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>instance_sampler<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>With all that done we can now move onto the vertex shader. Let's start with the new uniforms. <em>Don't forget to delete the old <code>buffer</code> block.</em></p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token comment">// we use a texture1D instead of texture2d because our texture is 1D</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>set <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> binding <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">uniform</span> texture1D t_model<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>set <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> binding <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">uniform</span> sampler s_model<span class="token punctuation">;</span>
</code></pre></div><p>The next part is a little more intensive, as there's now built in way to process our texture data as matrix data. We'll have to write a function to do that.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">mat4</span> <span class="token function">get_matrix</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">mat4</span><span class="token punctuation">(</span>
        <span class="token function">texelFetch</span><span class="token punctuation">(</span><span class="token keyword">sampler1D</span><span class="token punctuation">(</span>t_model<span class="token punctuation">,</span> s_model<span class="token punctuation">)</span><span class="token punctuation">,</span> index <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">texelFetch</span><span class="token punctuation">(</span><span class="token keyword">sampler1D</span><span class="token punctuation">(</span>t_model<span class="token punctuation">,</span> s_model<span class="token punctuation">)</span><span class="token punctuation">,</span> index <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">texelFetch</span><span class="token punctuation">(</span><span class="token keyword">sampler1D</span><span class="token punctuation">(</span>t_model<span class="token punctuation">,</span> s_model<span class="token punctuation">)</span><span class="token punctuation">,</span> index <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">texelFetch</span><span class="token punctuation">(</span><span class="token keyword">sampler1D</span><span class="token punctuation">(</span>t_model<span class="token punctuation">,</span> s_model<span class="token punctuation">)</span><span class="token punctuation">,</span> index <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This function takes in the index of the instance of the model we are rendering, and pulls our 4 pixels from the image corresponding to to 4 sets of floats that make up that instance's matrix. It then packs them into a <code>mat4</code> and returns that.</p> <p>Now we need to change our <code>main()</code> function to use <code>get_matrix()</code>.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v_tex_coords <span class="token operator">=</span> a_tex_coords<span class="token punctuation">;</span>
    <span class="token keyword">mat4</span> transform <span class="token operator">=</span> <span class="token function">get_matrix</span><span class="token punctuation">(</span>gl_InstanceIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> u_view_proj <span class="token operator">*</span> transform <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>There's a couple of things we need to do before this method will work. First <code>instance_buffer</code> we'll need to be <code>BufferUsage::COPY_SRC</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> instance_buffer <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_buffer_with_data</span><span class="token punctuation">(</span>
    bytemuck<span class="token punctuation">::</span><span class="token function">cast_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>instance_data<span class="token punctuation">)</span><span class="token punctuation">,</span>
    wgpu<span class="token punctuation">::</span>BufferUsage<span class="token punctuation">::</span>COPY_SRC<span class="token punctuation">,</span> <span class="token comment">// UPDATED!</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>You'll need is to remove <code>InstanceRaw::desc()</code> from the <code>render_pipeline</code>'s <code>vertex_state</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> render_pipeline <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_render_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>RenderPipelineDescriptor <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    vertex_state<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>VertexStateDescriptor <span class="token punctuation">{</span>
        index_format<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>IndexFormat<span class="token punctuation">::</span>Uint16<span class="token punctuation">,</span>
        vertex_buffers<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
            Vertex<span class="token punctuation">::</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Lastly you'll want to store <code>instance_texture</code> in <code>State</code> to prevent it from being disposed of.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// new()</span>
<span class="token keyword">Self</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    instance_texture<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>That's a lot more work than the other method's, but it's still good to know that you can use textures store things other then color. This technique does come in handy when other solutions are not available, or not as performant. It's good to be aware of the possibilities!</p> <p>For fun, here's what our matrix data looks like when converted into a texture (scaled up 10 times)!</p> <p><img src="/learn-wgpu/assets/img/instance_texture_scaled.9d12560d.png" alt="lots of colorful squares"></p> <h2 id="recap"><a href="#recap" class="header-anchor">#</a> Recap</h2> <table style="width:100%;"><tr><th>Technique</th> <th>Pros</th> <th>Cons</th></tr> <tr><td>Naive Approach</td> <td><ul><li>Super simple</li></ul></td> <td><ul><li>Super slow with lots of instances</li></ul></td></tr> <tr><td>Uniform Buffer</td> <td><ul><li>Quicker then other techniques</li></ul></td> <td><ul><li>Requires using fixed size array</li> <li>Limited size</li> <li>Requires a bind group</li></ul></td></tr> <tr><td>Storage Buffer</td> <td><ul><li>Larger size</li> <li>Allows modifying data</li> <li>We can use <code>Vec</code></li></ul></td> <td><ul><li>Slower than uniform buffers</li> <li>Requires a bind group</li></ul></td></tr> <tr><td>Instance Buffer</td> <td><ul><li>Larger size</li> <li>Doesn't need <code>gl_InstanceIndex</code></li></ul></td> <td><ul><li>Requires <code>VertexBufferDescriptor</code></li> <li>Requires passing in the vertex buffer to the render pass</li> <li>Vertex attributes are limited in size (4 floats)</li></ul></td></tr> <tr><td>Textures</td> <td><ul><li>Universally supported</li> <li>Faster than naive approach</li></ul></td> <td><ul><li>Requires decoding data manually</li> <li>Limited to by pixel format</li> <li>Requires a copying data to the texture via buffer</li> <li>Requires a bind group</li></ul></td></tr></table> <h2 id="about-the-depth-issues"><a href="#about-the-depth-issues" class="header-anchor">#</a> About the depth issues...</h2> <p>You may have noticed that some of the back pentagons are rendering in front of the ones in the front. This is a draw order issue. We could solve this by sorting the instances from back to front, that would only work from certain camera angles. A more flexible approach would be to use a <em>depth buffer</em>. We'll talk about those <a href="/todo">next time</a>.</p> <h2 id="challenge"><a href="#challenge" class="header-anchor">#</a> Challenge</h2> <p>Modify the position and/or rotation of the instances every frame.</p> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/beginner/tutorial7-instancing/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">5/11/2020, 10:24:44 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        
        <a href="/learn-wgpu/beginner/tutorial6-uniforms/" class="prev">
          Uniform buffers and a 3d camera
        </a></span> <span class="next"><a href="/learn-wgpu/beginner/tutorial8-depth/">
          The Depth Buffer
        </a>
        
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu/assets/js/app.f81b0d6c.js" defer></script><script src="/learn-wgpu/assets/js/2.0cd910cf.js" defer></script><script src="/learn-wgpu/assets/js/11.638df742.js" defer></script><script src="/learn-wgpu/assets/js/19.9711265a.js" defer></script>
  </body>
</html>
