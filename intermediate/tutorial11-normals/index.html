<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Normal Mapping | Learn Wgpu</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="">
    <meta property="article:modified_time" content="2020-05-04T19:03:26.000Z">
    <meta property="og:site_name" content="Learn Wgpu">
    <meta property="og:title" content="Normal Mapping">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/intermediate/tutorial11-normals/">
    <meta name="twitter:title" content="Normal Mapping">
    <meta name="twitter:url" content="/intermediate/tutorial11-normals/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data2" content="Benjamin R Hansen">
    <meta name="twitter:creator" content="https://twitter.com/sotrh760">
    <link rel="preload" href="/learn-wgpu/assets/css/0.styles.37e58535.css" as="style"><link rel="preload" href="/learn-wgpu/assets/js/app.f81b0d6c.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/2.0cd910cf.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/4.e7bd6c5d.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/19.9711265a.js" as="script"><link rel="prefetch" href="/learn-wgpu/assets/js/10.9e2a47f6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/11.638df742.js"><link rel="prefetch" href="/learn-wgpu/assets/js/12.6c2c8778.js"><link rel="prefetch" href="/learn-wgpu/assets/js/13.7dc1ded5.js"><link rel="prefetch" href="/learn-wgpu/assets/js/14.510faa9f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/15.c21d69e1.js"><link rel="prefetch" href="/learn-wgpu/assets/js/16.67a463f3.js"><link rel="prefetch" href="/learn-wgpu/assets/js/17.c6d24d48.js"><link rel="prefetch" href="/learn-wgpu/assets/js/18.43a69954.js"><link rel="prefetch" href="/learn-wgpu/assets/js/20.62f9e814.js"><link rel="prefetch" href="/learn-wgpu/assets/js/21.d6f10868.js"><link rel="prefetch" href="/learn-wgpu/assets/js/22.73b0831f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/23.2c0eb363.js"><link rel="prefetch" href="/learn-wgpu/assets/js/24.a2e97358.js"><link rel="prefetch" href="/learn-wgpu/assets/js/25.8c4b3520.js"><link rel="prefetch" href="/learn-wgpu/assets/js/3.e0ae4f10.js"><link rel="prefetch" href="/learn-wgpu/assets/js/5.e163b378.js"><link rel="prefetch" href="/learn-wgpu/assets/js/6.0d8ed5e8.js"><link rel="prefetch" href="/learn-wgpu/assets/js/7.20645a46.js"><link rel="prefetch" href="/learn-wgpu/assets/js/8.a40e7f6a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/9.87b3cb21.js">
    <link rel="stylesheet" href="/learn-wgpu/assets/css/0.styles.37e58535.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu/" class="home-link router-link-active"><!----> <span class="site-name">Learn Wgpu</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu/" class="sidebar-link">Introduction</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Beginner</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/beginner/tutorial1-window/" class="sidebar-link">Dependencies and the window</a></li><li><a href="/learn-wgpu/beginner/tutorial2-swapchain/" class="sidebar-link">The Swapchain</a></li><li><a href="/learn-wgpu/beginner/tutorial3-pipeline/" class="sidebar-link">The Pipeline</a></li><li><a href="/learn-wgpu/beginner/tutorial4-buffer/" class="sidebar-link">Buffers and Indices</a></li><li><a href="/learn-wgpu/beginner/tutorial5-textures/" class="sidebar-link">Textures and bind groups</a></li><li><a href="/learn-wgpu/beginner/tutorial6-uniforms/" class="sidebar-link">Uniform buffers and a 3d camera</a></li><li><a href="/learn-wgpu/beginner/tutorial7-instancing/" class="sidebar-link">Instancing</a></li><li><a href="/learn-wgpu/beginner/tutorial8-depth/" class="sidebar-link">The Depth Buffer</a></li><li><a href="/learn-wgpu/beginner/tutorial9-models/" class="sidebar-link">Model Loading</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Intermediate</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/intermediate/tutorial10-lighting/" class="sidebar-link">Working with Lights</a></li><li><a href="/learn-wgpu/intermediate/tutorial11-normals/" class="active sidebar-link">Normal Mapping</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial11-normals/#tangent-space-to-world-space" class="sidebar-link">Tangent Space to World Space</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial11-normals/#the-tangent-and-the-bitangent" class="sidebar-link">The tangent, and the bitangent</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial11-normals/#shader-time" class="sidebar-link">Shader time!</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial11-normals/#eww-matrix-multiplication-in-the-fragment-shader" class="sidebar-link">Eww, matrix multiplication in the fragment shader...</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial11-normals/#world-space-to-tangent-space" class="sidebar-link">World Space to Tangent Space</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial11-normals/#unrelated-stuff" class="sidebar-link">Unrelated stuff</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Showcase</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/learn-wgpu/news/" class="sidebar-link">News</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="normal-mapping"><a href="#normal-mapping" class="header-anchor">#</a> Normal Mapping</h1> <p>With just lighting, our scene is already looking pretty good. Still, our models are still overly smooth. This is understandable because we are using a very simple model. If we were using a texture that was supposed to be smooth, this wouldn't be a problem, but our brick texture is supposed to be rougher. We could solve this by adding more geometry, but that would slow our scene down, and it would hard to know where to new polygons. This is were normal mapping comes in.</p> <p>Remember in <a href="/learn-wgpu/beginner/tutorial7-instancing/#a-different-way-textures">the instancing tutorial</a>, we experimented with storing instance data in a texture? A normal map is doing just that with normal data! We'll use the normals in the normal map in our lighting calculation in addition to the vertex normal.</p> <p>The brick texture I found came with a normal map. Let's take a look at it!</p> <p><img src="/learn-wgpu/assets/img/cube-normal.025f2b53.png" alt="./cube-normal.png"></p> <p>The r, g, and b components of the texture correspond to the x, y, and z components or the normals. All the z values should be positive, that's why the normal map has a bluish tint.</p> <p>We'll need to modify our <code>Material</code> struct in <code>model.rs</code> to include a <code>normal_texture</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> Material <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> name<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> diffuse_texture<span class="token punctuation">:</span> texture<span class="token punctuation">::</span>Texture<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> normal_texture<span class="token punctuation">:</span> texture<span class="token punctuation">::</span>Texture<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> bind_group<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindGroup<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We'll have to update the <code>texture_bind_group_layout</code> to include the normal map as well.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> texture_bind_group_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>BindGroupLayoutDescriptor <span class="token punctuation">{</span>
    bindings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// normal map</span>
        wgpu<span class="token punctuation">::</span>BindGroupLayoutEntry <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            visibility<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>ShaderStage<span class="token punctuation">::</span>FRAGMENT<span class="token punctuation">,</span>
            ty<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingType<span class="token punctuation">::</span>SampledTexture <span class="token punctuation">{</span>
                multisampled<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
                component_type<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>TextureComponentType<span class="token punctuation">::</span>Float<span class="token punctuation">,</span>
                dimension<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>TextureViewDimension<span class="token punctuation">::</span>D2<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        wgpu<span class="token punctuation">::</span>BindGroupLayoutEntry <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            visibility<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>ShaderStage<span class="token punctuation">::</span>FRAGMENT<span class="token punctuation">,</span>
            ty<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingType<span class="token punctuation">::</span>Sampler <span class="token punctuation">{</span> comparison<span class="token punctuation">:</span> <span class="token keyword">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    label<span class="token punctuation">:</span> None<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We'll need to actually the normal map itself. We'll do this in the loop we create the materials in.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> diffuse_path <span class="token operator">=</span> mat<span class="token punctuation">.</span>diffuse_texture<span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token punctuation">(</span>diffuse_texture<span class="token punctuation">,</span> cmds<span class="token punctuation">)</span> <span class="token operator">=</span> texture<span class="token punctuation">::</span>Texture<span class="token punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span>device<span class="token punctuation">,</span> containing_folder<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>diffuse_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
command_buffers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cmds<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> normal_path <span class="token operator">=</span> <span class="token keyword">match</span> mat<span class="token punctuation">.</span>unknown_param<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;map_Bump&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">Some</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Ok</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span>
    None <span class="token operator">=&gt;</span> <span class="token function">Err</span><span class="token punctuation">(</span>failure<span class="token punctuation">::</span><span class="token function">err_msg</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to find normal map&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token punctuation">(</span>normal_texture<span class="token punctuation">,</span> cmds<span class="token punctuation">)</span> <span class="token operator">=</span> texture<span class="token punctuation">::</span>Texture<span class="token punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span>device<span class="token punctuation">,</span> containing_folder<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>normal_path<span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
command_buffers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cmds<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>Note: I duplicated and moved teh <code>command_buffers.push(cmds);</code> line. This means we can reuse the <code>cmds</code> variable for both the normal map and diffuse/color map.</li></ul> <p>Our <code>Material</code>'s <code>bind_group</code> will have to change as well.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>BindGroupDescriptor <span class="token punctuation">{</span>
    layout<span class="token punctuation">,</span>
    bindings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        <span class="token comment">// ...</span>
        wgpu<span class="token punctuation">::</span>Binding <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            resource<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingResource<span class="token punctuation">::</span><span class="token function">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>normal_texture<span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        wgpu<span class="token punctuation">::</span>Binding <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            resource<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingResource<span class="token punctuation">::</span><span class="token function">Sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>normal_texture<span class="token punctuation">.</span>sampler<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    label<span class="token punctuation">:</span> None<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Don't forget to pass the <code>normal_texture</code> into the <code>Material</code> struct!</p> <div class="language-rust extra-class"><pre class="language-rust"><code>materials<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Material <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> mat<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    diffuse_texture<span class="token punctuation">,</span>
    normal_texture<span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
    bind_group<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now we can add use the texture in the fragment shader.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token comment">// shader.frag</span>
<span class="token comment">// ...</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> binding <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">uniform</span> texture2D t_normal<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> binding <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">uniform</span> sampler s_normal<span class="token punctuation">;</span>

<span class="token comment">// ...</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">vec4</span> object_color <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span><span class="token keyword">sampler2D</span><span class="token punctuation">(</span>t_diffuse<span class="token punctuation">,</span> s_diffuse<span class="token punctuation">)</span><span class="token punctuation">,</span> v_tex_coords<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec4</span> object_normal <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span><span class="token keyword">sampler2D</span><span class="token punctuation">(</span>t_normal<span class="token punctuation">,</span> s_normal<span class="token punctuation">)</span><span class="token punctuation">,</span> v_tex_coords<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// NEW!</span>

    <span class="token comment">// ...</span>

    <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>object_normal<span class="token punctuation">.</span>rgb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// UPDATED!</span>
    
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now if you've used normal mapping in OpenGL, you may be wondering by we didn't adjust the normal value. Normally you'd do something like the following.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>object_normal<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token number">2.0</span> <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We don't have to do this because we are using <code>wgpu::TextureFormat::Rgba8UnormSrgb</code>, our shader gets the texture data in the range of [-1.0, 1.0].</p> <p>If we run the code now, you'll notice things don't look quite right. Let's compare our results with the last tutorial.</p> <p><img src="/learn-wgpu/assets/img/normal_mapping_wrong.306d18c8.png" alt=""> <img src="/learn-wgpu/assets/img/ambient_diffuse_specular_lighting.76386148.png" alt=""></p> <p>Parts of the scene are dark when they should be lit up, and vice versa.</p> <h2 id="tangent-space-to-world-space"><a href="#tangent-space-to-world-space" class="header-anchor">#</a> Tangent Space to World Space</h2> <p>I mentioned it briefly in the <a href="/learn-wgpu/intermediate/tutorial10-lighting/#the-normal-matrix">lighting tutorial</a>, that we were doing our lighting calculation in &quot;world space&quot;. This meant that the entire scene was oriented with respect to the <em>world's</em> coordinate system. When we pull the normal data from our normal texture, all the normals are in what's known as  pointing roughly in the positive z direction. That means that our lighting calculation thinks all of the surfaces of our models are facing in roughly the same direction. This is referred to as <code>tangent space</code>.</p> <p>If we remember the <a href="/learn-wgpu/intermediate/tutorial10-lighting/#">lighting-tutorial</a>, we used the vertex normal to indicate the direction of the surface. It turns out we can use that to transform our normals from <code>tangent space</code> into <code>world space</code>. In order to do that we need to draw from the depths of linear algebra.</p> <p>We can create a matrix that represents a coordinate system using 3 vectors that are perpendicular (or orthonormal) to each other. Basically we define the x, y, and z axes of our coordinate system.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">mat3</span> coordinate_system <span class="token operator">=</span> <span class="token keyword">mat3</span><span class="token punctuation">(</span>
    <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// x axis (right)</span>
    <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// y axis (up)</span>
    <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">// z axis (forward)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We're going to create a matrix that will represent the coordinate space relative to our vertex normals. We're then going to use that to transform our normal map data to be in world space.</p> <h2 id="the-tangent-and-the-bitangent"><a href="#the-tangent-and-the-bitangent" class="header-anchor">#</a> The tangent, and the bitangent</h2> <p>We have one of the 3 vectors we need, the normal. What about the others? These are the tangent, and bitangent vectors. A tangent represents any vector that is parallel with a surface (aka. doesn't intersect with it). The tangent is always perpendicular to the normal vector. The bitangent is a tangent vector that is perpendicular to the other tangent vector. Together the tangent, bitangent, and normal represent the x, y, and z axes respectively.</p> <p>Some model formats include the tanget and bitangent (sometimes called the binormal) in the vertex data, but OBJ does not. We'll have to calculate them manually. Luckily we can derive our tangent, and bitangent from our existing vertex data. Take a look at the following diagram.</p> <p><img src="data:image/png;base64,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" alt=""></p> <p>Basically we can use the edges of our triangles, and our normal to calculate the tangent and bitangent. But first, we need to update our <code>ModelVertex</code> struct in <code>model.rs</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[derive(Copy, Clone, Debug)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> ModelVertex <span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Vector3<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    tex_coords<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Vector2<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    normal<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Vector3<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">// NEW!</span>
    tangent<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Vector3<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    bitangent<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Vector3<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We'll need to upgrade our <code>VertexBufferDescriptor</code> as well.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> Vertex <span class="token keyword">for</span> ModelVertex <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> desc<span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> wgpu<span class="token punctuation">::</span>VertexBufferDescriptor<span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> std<span class="token punctuation">::</span>mem<span class="token punctuation">;</span>
        wgpu<span class="token punctuation">::</span>VertexBufferDescriptor <span class="token punctuation">{</span>
            stride<span class="token punctuation">:</span> mem<span class="token punctuation">::</span>size_of<span class="token punctuation">::</span><span class="token operator">&lt;</span>ModelVertex<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> wgpu<span class="token punctuation">::</span>BufferAddress<span class="token punctuation">,</span>
            step_mode<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>InputStepMode<span class="token punctuation">::</span>Vertex<span class="token punctuation">,</span>
            attributes<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token comment">// ...</span>

                <span class="token comment">// Tangent and bitangent</span>
                wgpu<span class="token punctuation">::</span>VertexAttributeDescriptor <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> mem<span class="token punctuation">::</span>size_of<span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span>f32<span class="token punctuation">;</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> wgpu<span class="token punctuation">::</span>BufferAddress<span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>VertexFormat<span class="token punctuation">::</span>Float3<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                wgpu<span class="token punctuation">::</span>VertexAttributeDescriptor <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> mem<span class="token punctuation">::</span>size_of<span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span>f32<span class="token punctuation">;</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> wgpu<span class="token punctuation">::</span>BufferAddress<span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>VertexFormat<span class="token punctuation">::</span>Float3<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now we can calculate the new tangent, and bitangent vectors.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> Model <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> load<span class="token operator">&lt;</span>P<span class="token punctuation">:</span> AsRef<span class="token operator">&lt;</span>Path<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>
        device<span class="token punctuation">:</span> <span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>Device<span class="token punctuation">,</span>
        layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>BindGroupLayout<span class="token punctuation">,</span>
        path<span class="token punctuation">:</span> P<span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">Self</span><span class="token punctuation">,</span> Vec<span class="token operator">&lt;</span>wgpu<span class="token punctuation">::</span>CommandBuffer<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> failure<span class="token punctuation">::</span>Error<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">for</span> m <span class="token keyword">in</span> obj_models <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> vertices <span class="token operator">=</span> Vec<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>m<span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>positions<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span> <span class="token punctuation">{</span>
                vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>ModelVertex <span class="token punctuation">{</span>
                    <span class="token comment">// ...</span>
                    <span class="token comment">// We'll calculate these later</span>
                    tangent<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    bitangent<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">let</span> indices <span class="token operator">=</span> <span class="token operator">&amp;</span>m<span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>indices<span class="token punctuation">;</span>

            <span class="token comment">// Calculate tangents and bitangets. We're going to</span>
            <span class="token comment">// use the triangles, so we need to loop through the</span>
            <span class="token comment">// indices in chunks of 3</span>
            <span class="token keyword">for</span> c <span class="token keyword">in</span> indices<span class="token punctuation">.</span><span class="token function">chunks</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> v0 <span class="token operator">=</span> vertices<span class="token punctuation">[</span>c<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> v1 <span class="token operator">=</span> vertices<span class="token punctuation">[</span>c<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> v2 <span class="token operator">=</span> vertices<span class="token punctuation">[</span>c<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">;</span>

                <span class="token keyword">let</span> pos0 <span class="token operator">=</span> v0<span class="token punctuation">.</span>position<span class="token punctuation">;</span>
                <span class="token keyword">let</span> pos1 <span class="token operator">=</span> v1<span class="token punctuation">.</span>position<span class="token punctuation">;</span>
                <span class="token keyword">let</span> pos2 <span class="token operator">=</span> v2<span class="token punctuation">.</span>position<span class="token punctuation">;</span>

                <span class="token keyword">let</span> uv0 <span class="token operator">=</span> v0<span class="token punctuation">.</span>tex_coords<span class="token punctuation">;</span>
                <span class="token keyword">let</span> uv1 <span class="token operator">=</span> v1<span class="token punctuation">.</span>tex_coords<span class="token punctuation">;</span>
                <span class="token keyword">let</span> uv2 <span class="token operator">=</span> v2<span class="token punctuation">.</span>tex_coords<span class="token punctuation">;</span>

                <span class="token comment">// Calculate the edges of the triangle</span>
                <span class="token keyword">let</span> delta_pos1 <span class="token operator">=</span> pos1 <span class="token operator">-</span> pos0<span class="token punctuation">;</span>
                <span class="token keyword">let</span> delta_pos2 <span class="token operator">=</span> pos2 <span class="token operator">-</span> pos0<span class="token punctuation">;</span>

                <span class="token comment">// This will give us a direction to calculate the</span>
                <span class="token comment">// tangent and bitangent</span>
                <span class="token keyword">let</span> delta_uv1 <span class="token operator">=</span> uv1 <span class="token operator">-</span> uv0<span class="token punctuation">;</span>
                <span class="token keyword">let</span> delta_uv2 <span class="token operator">=</span> uv2 <span class="token operator">-</span> uv0<span class="token punctuation">;</span>

                <span class="token comment">// Solving the following system of equations will</span>
                <span class="token comment">// give us the tangent and bitangent.</span>
                <span class="token comment">//     delta_pos1 = delta_uv1.x * T + delta_u.y * B</span>
                <span class="token comment">//     delta_pos2 = delta_uv2.x * T + delta_uv2.y * B</span>
                <span class="token comment">// Luckily, the place I found this equation provided </span>
                <span class="token comment">// the solution!</span>
                <span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>delta_uv1 <span class="token punctuation">.</span>x <span class="token operator">*</span> delta_uv2<span class="token punctuation">.</span>y <span class="token operator">-</span> delta_uv1<span class="token punctuation">.</span>y <span class="token operator">*</span> delta_uv2<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> tangent <span class="token operator">=</span> <span class="token punctuation">(</span>delta_pos1 <span class="token operator">*</span> delta_uv2<span class="token punctuation">.</span>y <span class="token operator">-</span> delta_pos2 <span class="token operator">*</span> delta_uv1<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">*</span> r<span class="token punctuation">;</span>
                <span class="token keyword">let</span> bitangent <span class="token operator">=</span> <span class="token punctuation">(</span>delta_pos2 <span class="token operator">*</span> delta_uv1<span class="token punctuation">.</span>x <span class="token operator">-</span> delta_pos1 <span class="token operator">*</span> delta_uv2<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">*</span> r<span class="token punctuation">;</span>
                
                <span class="token comment">// We'll use the same tangent/bitangent for each vertex in the triangle</span>
                vertices<span class="token punctuation">[</span>c<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">.</span>tangent <span class="token operator">=</span> tangent<span class="token punctuation">;</span>
                vertices<span class="token punctuation">[</span>c<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">.</span>tangent <span class="token operator">=</span> tangent<span class="token punctuation">;</span>
                vertices<span class="token punctuation">[</span>c<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">.</span>tangent <span class="token operator">=</span> tangent<span class="token punctuation">;</span>

                vertices<span class="token punctuation">[</span>c<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">.</span>bitangent <span class="token operator">=</span> bitangent<span class="token punctuation">;</span>
                vertices<span class="token punctuation">[</span>c<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">.</span>bitangent <span class="token operator">=</span> bitangent<span class="token punctuation">;</span>
                vertices<span class="token punctuation">[</span>c<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">.</span>bitangent <span class="token operator">=</span> bitangent<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">Self</span> <span class="token punctuation">{</span> meshes<span class="token punctuation">,</span> materials <span class="token punctuation">}</span><span class="token punctuation">,</span> command_buffers<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="shader-time"><a href="#shader-time" class="header-anchor">#</a> Shader time!</h2> <p>The fragment shader needs to be updated to include our tangent and bitangent.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token comment">// shader.vert</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> a_position<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> a_tex_coords<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> a_normal<span class="token punctuation">;</span>
<span class="token comment">// NEW!</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> a_tangent<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> a_bitangent<span class="token punctuation">;</span>
</code></pre></div><p>We're going to change up the output variables as well. We're going to calculate a <code>tangent_matrix</code> that we're going to pass to the fragment shader. We're also going to remove <code>v_normal</code> as we will be using the normal map data instead.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec2</span> v_tex_coords<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec3</span> v_position<span class="token punctuation">;</span> <span class="token comment">// UPDATED!</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">mat3</span> v_tangent_matrix<span class="token punctuation">;</span> <span class="token comment">// NEW!</span>
</code></pre></div><p>We need to reflect these updates in the fragment shader as well. We'll also transform the normal into <code>world space</code>.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token comment">// shader.frag</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> v_tex_coords<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> v_position<span class="token punctuation">;</span> <span class="token comment">// UPDATED!</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">mat3</span> v_tangent_matrix<span class="token punctuation">;</span> <span class="token comment">// NEW!</span>

<span class="token comment">// ...</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_tangent_matrix <span class="token operator">*</span> object_normal<span class="token punctuation">.</span>rgb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>With that we get the following.</p> <p><img src="/learn-wgpu/assets/img/normal_mapping_correct.2731b486.png" alt=""></p> <h2 id="eww-matrix-multiplication-in-the-fragment-shader"><a href="#eww-matrix-multiplication-in-the-fragment-shader" class="header-anchor">#</a> Eww, matrix multiplication in the fragment shader...</h2> <p>Currently we are transforming the normal in the fragment shader. The fragment shader gets run for <strong>every pixel</strong>. To say this is inefficient is an understatement. Even so, we can't do the transformation in the vertex shader since we need to sample the normal map in the pixel shader. If want to use the <code>tangent_matrix</code> out of the fragment shader, we're going to have to think outside the box.</p> <h2 id="world-space-to-tangent-space"><a href="#world-space-to-tangent-space" class="header-anchor">#</a> World Space to Tangent Space</h2> <p>The variables we're using in the lighting calculation are <code>v_position</code>, <code>light_position</code>, and <code>u_view_position</code>. These are in <code>world space</code> while our normals are in <code>tangent space</code>. We can convert from <code>world space</code> to <code>tangent space</code> by multiplying by the inverse of the <code>tangent_matrix</code>. The inverse operation is a little expensive, but because our <code>tangent_matrix</code> is made up of vectors that are perpendicular to each other (aka. orthonormal), we can use the <code>transpose()</code> function instead!</p> <p>But first, we need to change up our output variables, and import the <code>Light</code> uniforms.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token comment">// ...</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec2</span> v_tex_coords<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec3</span> v_position<span class="token punctuation">;</span> <span class="token comment">// UPDATED!</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec3</span> v_light_position<span class="token punctuation">;</span> <span class="token comment">// NEW!</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec3</span> v_view_position<span class="token punctuation">;</span> <span class="token comment">// NEW!</span>
<span class="token comment">// ...</span>

<span class="token comment">// NEW!</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>set<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> binding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">uniform</span> Light <span class="token punctuation">{</span>
    <span class="token keyword">vec3</span> light_position<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> light_color<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Now we'll convert the other lighting values as follows.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// UDPATED!</span>
    <span class="token keyword">mat3</span> tangent_matrix <span class="token operator">=</span> <span class="token function">transpose</span><span class="token punctuation">(</span><span class="token keyword">mat3</span><span class="token punctuation">(</span>
        tangent<span class="token punctuation">,</span>
        bitangent<span class="token punctuation">,</span>
        normal
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">vec4</span> model_space <span class="token operator">=</span> model_matrix <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v_position <span class="token operator">=</span> model_space<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>

    <span class="token comment">// NEW!</span>
    v_position <span class="token operator">=</span> tangent_matrix <span class="token operator">*</span> model_space<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    v_light_position <span class="token operator">=</span> tangent_matrix <span class="token operator">*</span> light_position<span class="token punctuation">;</span>
    v_view_position <span class="token operator">=</span> tangent_matrix <span class="token operator">*</span> u_view_position<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Finally we'll update <code>shader.frag</code> to import and use the transformed lighting values.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token preprocessor builtin">#version</span> <span class="token number">450</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> v_tex_coords<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> v_position<span class="token punctuation">;</span> <span class="token comment">// UPDATED!</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> v_light_position<span class="token punctuation">;</span> <span class="token comment">// NEW!</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> v_view_position<span class="token punctuation">;</span> <span class="token comment">// NEW!</span>
<span class="token comment">// ...</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>object_normal<span class="token punctuation">.</span>rgb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// UPDATED!</span>
    <span class="token keyword">vec3</span> light_dir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_light_position <span class="token operator">-</span> v_position<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// UPDATED!</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">vec3</span> view_dir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_view_position <span class="token operator">-</span> v_position<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// UPDATED!</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The resulting image isn't noticeably different so I won't show it here, but the calculation definitely is more efficient.</p> <h2 id="unrelated-stuff"><a href="#unrelated-stuff" class="header-anchor">#</a> Unrelated stuff</h2> <p>While I was debugging the normal mapping code, I made a few changes to <code>model.rs</code> that I haven't mentioned. I wanted to be able to see the model with different textures, so I modified the <code>Material</code> struct to have a <code>new()</code> method.</p> <div class="language-rust extra-class"><pre class="language-rust"><code>
<span class="token keyword">impl</span> Material <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>
        device<span class="token punctuation">:</span> <span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>Device<span class="token punctuation">,</span> 
        name<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">,</span> 
        diffuse_texture<span class="token punctuation">:</span> texture<span class="token punctuation">::</span>Texture<span class="token punctuation">,</span> 
        normal_texture<span class="token punctuation">:</span> texture<span class="token punctuation">::</span>Texture<span class="token punctuation">,</span>
        layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>BindGroupLayout<span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>BindGroupDescriptor <span class="token punctuation">{</span>
            layout<span class="token punctuation">,</span>
            bindings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                wgpu<span class="token punctuation">::</span>Binding <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    resource<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingResource<span class="token punctuation">::</span><span class="token function">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>diffuse_texture<span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                wgpu<span class="token punctuation">::</span>Binding <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    resource<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingResource<span class="token punctuation">::</span><span class="token function">Sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>diffuse_texture<span class="token punctuation">.</span>sampler<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                wgpu<span class="token punctuation">::</span>Binding <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                    resource<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingResource<span class="token punctuation">::</span><span class="token function">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>normal_texture<span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                wgpu<span class="token punctuation">::</span>Binding <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                    resource<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingResource<span class="token punctuation">::</span><span class="token function">Sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>normal_texture<span class="token punctuation">.</span>sampler<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            label<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">Self</span> <span class="token punctuation">{</span> 
            name<span class="token punctuation">:</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
            diffuse_texture<span class="token punctuation">,</span>
            normal_texture<span class="token punctuation">,</span>
            bind_group<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This simplifies the code in <code>Model::load()</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> <span class="token keyword">mut</span> materials <span class="token operator">=</span> Vec<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> mat <span class="token keyword">in</span> obj_materials <span class="token punctuation">{</span>
    <span class="token keyword">let</span> diffuse_path <span class="token operator">=</span> mat<span class="token punctuation">.</span>diffuse_texture<span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>diffuse_texture<span class="token punctuation">,</span> cmds<span class="token punctuation">)</span> <span class="token operator">=</span> texture<span class="token punctuation">::</span>Texture<span class="token punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span>device<span class="token punctuation">,</span> containing_folder<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>diffuse_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    command_buffers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cmds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">let</span> normal_path <span class="token operator">=</span> <span class="token keyword">match</span> mat<span class="token punctuation">.</span>unknown_param<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;map_Bump&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">Some</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Ok</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span>
        None <span class="token operator">=&gt;</span> <span class="token function">Err</span><span class="token punctuation">(</span>failure<span class="token punctuation">::</span><span class="token function">err_msg</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to find normal map&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>normal_texture<span class="token punctuation">,</span> cmds<span class="token punctuation">)</span> <span class="token operator">=</span> texture<span class="token punctuation">::</span>Texture<span class="token punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span>device<span class="token punctuation">,</span> containing_folder<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>normal_path<span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    command_buffers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cmds<span class="token punctuation">)</span><span class="token punctuation">;</span>

    materials<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Material<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
        device<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>mat<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        diffuse_texture<span class="token punctuation">,</span>
        normal_texture<span class="token punctuation">,</span>
        layout<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>I also added a <code>draw_model_instanced_with_material()</code> to the <code>DrawModel</code> trait.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> DrawModel<span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a,</span> <span class="token lifetime-annotation symbol">'b</span><span class="token operator">&gt;</span>
<span class="token keyword">where</span>
    <span class="token lifetime-annotation symbol">'b:</span> <span class="token lifetime-annotation symbol">'a,</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">fn</span> <span class="token function">draw_model_instanced_with_material</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        model<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> Model<span class="token punctuation">,</span>
        material<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> Material<span class="token punctuation">,</span>
        instances<span class="token punctuation">:</span> Range<span class="token operator">&lt;</span>u32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
        uniforms<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> wgpu<span class="token punctuation">::</span>BindGroup<span class="token punctuation">,</span>
        light<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> wgpu<span class="token punctuation">::</span>BindGroup<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a,</span> <span class="token lifetime-annotation symbol">'b</span><span class="token operator">&gt;</span> DrawModel<span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a,</span> <span class="token lifetime-annotation symbol">'b</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> wgpu<span class="token punctuation">::</span>RenderPass<span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span>
<span class="token keyword">where</span>
    <span class="token lifetime-annotation symbol">'b:</span> <span class="token lifetime-annotation symbol">'a,</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">fn</span> <span class="token function">draw_model_instanced_with_material</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        model<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> Model<span class="token punctuation">,</span>
        material<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> Material<span class="token punctuation">,</span>
        instances<span class="token punctuation">:</span> Range<span class="token operator">&lt;</span>u32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
        uniforms<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> wgpu<span class="token punctuation">::</span>BindGroup<span class="token punctuation">,</span>
        light<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> wgpu<span class="token punctuation">::</span>BindGroup<span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> mesh <span class="token keyword">in</span> <span class="token operator">&amp;</span>model<span class="token punctuation">.</span>meshes <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">draw_mesh_instanced</span><span class="token punctuation">(</span>mesh<span class="token punctuation">,</span> material<span class="token punctuation">,</span> instances<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uniforms<span class="token punctuation">,</span> light<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>I found a cobblestone texture with matching normal map, and created a <code>debug_material</code> for that.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// new()</span>
<span class="token keyword">let</span> debug_material <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> diffuse_bytes <span class="token operator">=</span> <span class="token function">include_bytes!</span><span class="token punctuation">(</span><span class="token string">&quot;res/cobble-diffuse.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> normal_bytes <span class="token operator">=</span> <span class="token function">include_bytes!</span><span class="token punctuation">(</span><span class="token string">&quot;res/cobble-normal.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> command_buffers <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>diffuse_texture<span class="token punctuation">,</span> cmds<span class="token punctuation">)</span> <span class="token operator">=</span> texture<span class="token punctuation">::</span>Texture<span class="token punctuation">::</span><span class="token function">from_bytes</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>device<span class="token punctuation">,</span> diffuse_bytes<span class="token punctuation">,</span> <span class="token string">&quot;res/alt-diffuse.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    command_buffers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cmds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>normal_texture<span class="token punctuation">,</span> cmds<span class="token punctuation">)</span> <span class="token operator">=</span> texture<span class="token punctuation">::</span>Texture<span class="token punctuation">::</span><span class="token function">from_bytes</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>device<span class="token punctuation">,</span> normal_bytes<span class="token punctuation">,</span> <span class="token string">&quot;res/alt-normal.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    command_buffers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cmds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    queue<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>command_buffers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    model<span class="token punctuation">::</span>Material<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>device<span class="token punctuation">,</span> <span class="token string">&quot;alt-material&quot;</span><span class="token punctuation">,</span> diffuse_texture<span class="token punctuation">,</span> normal_texture<span class="token punctuation">,</span> <span class="token operator">&amp;</span>texture_bind_group_layout<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">Self</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token attribute attr-name">#[allow(dead_code)]</span>
    debug_material<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Then to render with the <code>debug_material</code> I used the <code>draw_model_instanced_with_material()</code> that I created.</p> <div class="language-rust extra-class"><pre class="language-rust"><code>render_pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>render_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">draw_model_instanced_with_material</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>obj_model<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>debug_material<span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>instances<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u32<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>uniform_bind_group<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>light_bind_group<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>That gives us something like this.</p> <p><img src="/learn-wgpu/assets/img/debug_material.becf561e.png" alt=""></p> <p>You can find the textures I use in the Github Repository.</p> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/intermediate/tutorial11-normals/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">5/4/2020, 1:03:26 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        
        <a href="/learn-wgpu/intermediate/tutorial10-lighting/" class="prev">
          Working with Lights
        </a></span> <span class="next"><a href="/learn-wgpu/showcase/">
          Foreward
        </a>
        
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu/assets/js/app.f81b0d6c.js" defer></script><script src="/learn-wgpu/assets/js/2.0cd910cf.js" defer></script><script src="/learn-wgpu/assets/js/4.e7bd6c5d.js" defer></script><script src="/learn-wgpu/assets/js/19.9711265a.js" defer></script>
  </body>
</html>
